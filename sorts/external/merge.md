# Сортировка слиянием (Merge Sort)

## Классификация

**Важно написать**, что сортировка слияния относится к классу **внешних сортировок**: т.е. сортировок, эффективных для сортировки файлов и иных структур с последовательным доступом.

Последовательный характер доступа так или иначе доминирует на всех внешних устройствах и налагает весьма сильное ограничение, вынуждающее нас использовать другие методы сортировки.

## Идея алгоритма - Метод слияния

Характерным методом внешней сортировки является **метод слияния**. Под слиянием понимается подобное слиянию двух рек объединение двух или более упорядоченных входных последовательностей в одну-единственную упорядоченную выходную последовательность с помощью повторяющегося выбора из доступных в данный момент резидентных (буферных) элементов. 

**Слияние — очень простая и быстрая операция**, которую можно приспособить для задач внешней сортировки.

## Простое слияние

Идея слияния может быть применена и к неупорядоченным входным данным, при этом их упорядоченность будет постепенно возрастать в процессе нескольких слияний подпоследовательностей исходных данных до их полной упорядоченности. Рассмотрим идею сортировки **простым слиянием**:

### Алгоритм простого слияния

1. Последовательность `a` разбивается на две половины `b` и `c`

2. Части `b` и `c` **сливаются**; при этом одиночные элементы из разных частей образуют упорядоченные пары в выходной последовательности, т. е. первым в ней оказывается меньший из двух первых элементов этих частей

3. Полученная объединенная слиянием последовательность более упорядочена, чем исходная, и она вновь подвергается разделению и слиянию; при этом упорядоченные пары переходят в упорядоченные четверки, те переходят в восьмерки и т. д. до полной упорядоченности

### Пример

```
Исходная последовательность:
44  55  12  42  94  18  06  67

После разбиения на две части:
44  55  12  42
94  18  06  67

Слияние одиночных компонент в упорядоченные пары:
44  94'  18  55'  06  12'  42  67

Попарно и сливая упорядоченные пары:
06  12  44  94'  18  42  55  67

Слияние четверок:
06  12  44  94
18  42  55  67
```

И т.д. пока не будет отсортирована полностью.

## Терминология

- **Фаза**: Однократное слияние или разделение всего множества
- **Проход** или **этап**: Пара фаз разделение-слияние
- **Трехленточная сортировка**: Сортировка приведенного примера происходит за три двухфазных прохода, каждый из которых состоит из фазы разделения и фазы слияния. Для такой сортировки нужны три магнитофона и три ленты, поэтому она получила название *трехленточного слияния*

## Оптимизация: Однофазная четырехленточная сортировка

Заметим, что фазы разделения носят вспомогательный характер и не улучшают упорядоченности элементов. Поскольку при разделении элементы не переставляются, то половина трудоемкости сортировки слиянием, связанная с разделением, непродуктивна и от нее следует избавиться. 

Для этого применяется очень простой прием: **результат слияния сразу же распределяется по двум выходным лентам**, которые станут входными при следующем просмотре, поменявшись ролями с исходными лентами предыдущего этапа. Цена вопроса — еще один, четвертый, магнитофон (и лента). 

**Таким образом, вместо двухфазной трехленточной сортировки получаем однофазную четырехленточную с вдвое меньшей трудоемкостью.**

## Сложностная оценка

### Количество проходов

Количество проходов для этой сортировки есть `⌈log₂ n⌉`, поскольку при каждом проходе размер отсортированных отрезков удваивается.

### Общее число пересылок

$$M = n \cdot \lceil \log_2 n \rceil$$

поскольку при каждом проходе все элементы копируются по одному разу.

### Число сравнений

Число сравнений ключей `C` даже меньше `M`, т. к. при копировании остатков отрезков («слив») сравнения не производятся.

### Итоговая сложность

**Временная сложность:** `O(n log n)` во всех случаях (лучший, средний, худший)

**Пространственная сложность:** 
- Для внешней сортировки: требуется двойная память (дополнительные ленты/буферы)
- Для внутренней сортировки: `O(n)` дополнительной памяти

## Преимущества

- **Предсказуемая производительность**: `O(n log n)` в любом случае
- **Устойчивость**: Сортировка слиянием, в отличие от быстрой и даже пирамидальной, изначально является **устойчивой**
- **Эффективна для внешних устройств**: Последовательный доступ идеально подходит для лент, дисков
- **Хорошо распараллеливается**: Независимые слияния можно выполнять параллельно
- **Естественные варианты**: Можно модифицировать для учета частичной упорядоченности

## Недостатки

- **Требует дополнительной памяти**: Главным в оценке сортировки слиянием является большая пространственная сложность алгоритма — **двойная память**, требуемая последовательным характером слияния-разделения
- **Медленнее на малых массивах**: На практике для небольших массивов проигрывает более простым алгоритмам
- **Затраты на пересылки**: Однако, поскольку сортировки слиянием происходят на внешних электромеханических устройствах, то время пересылки между устройством внешней памяти и основной памятью на несколько порядков превышает время сравнения резидентных компонент в буферах оперативной памяти

## Применимость

### Внешняя сортировка

За эти недостатки многие программисты не вполне оправданно отказываются от ее применения для внутренней сортировки. 

**А между прочим**, сортировка слиянием, в отличие от быстрой и даже пирамидальной, изначально является устойчивой, и именно этот алгоритм предлагается в библиотеке STL под характерным названием `stable_sort()`.

### Оценка как внешней сортировки

В оценке сортировки слиянием как внешней следуют другим традициям, считая двойное количество лент (магнитофонов) вполне допустимым. Тем более, что количество магнитофонов постоянно `(O(1)!)` и совершенно не зависит от объема входных данных `(O(n))`, а емкость каждого магнитофона потенциально бесконечна по сравнению с емкостью ОП.

## Реализация

### Рекурсивная реализация

Классическая рекурсивная реализация:
1. Разделить массив пополам
2. Рекурсивно отсортировать каждую половину
3. Слить две отсортированные половины

### Итеративная реализация

Можно реализовать итеративно, начиная со слияния одиночных элементов, затем пар, четверок и т.д.

## Связь с другими алгоритмами

- **Timsort**: Гибридный алгоритм сортировки, основанный на сортировке слиянием и сортировке вставками (используется в Python и Java)
- **External sort**: Многие алгоритмы внешней сортировки основаны на идее слияния

## Экспериментальные данные

По данным эксперимента Н. Вирта (массив из 2048 элементов, скалярный ключ):

| Упорядоченный | Случайный | Обратный порядок |
|---------------|-----------|------------------|
| 1,98 | 2,06 | 1,98 |

Как видно, производительность практически не зависит от исходного порядка элементов, что подтверждает стабильность алгоритма.

## Заключение

Сортировка слиянием — это надежный, предсказуемый и устойчивый алгоритм, который особенно эффективен для:
- Внешней сортировки (файлы на дисках, лентах)
- Ситуаций, где требуется устойчивость
- Данных с последовательным доступом
- Параллельной обработки

Несмотря на требование дополнительной памяти, она остается одним из фундаментальных алгоритмов сортировки, широко используемым на практике, особенно в качестве основы для более сложных гибридных алгоритмов.

