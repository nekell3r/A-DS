# Сортировка естественным слиянием (Natural Merge Sort)

## Классификация

Относится к классу **внешних сортировок**. Является **естественной** модификацией обычной сортировки слиянием.

## Идея алгоритма

**Еще более быстрым** является **естественное слияние**. В основе этого алгоритма лежит предположение, что в исходном файле уже могут быть упорядоченные отрезки. 

Для простоты положим, что сортируемая последовательность изначально расположена на ленте 1, а ленты 2, 3 и 4 свободны, и последовательность необходимо упорядочить по возрастанию.

## Принцип работы

### Первая часть: Разбиение на упорядоченные отрезки

Первая часть естественного слияния заключается в **разбиении файла на ленте 1 и записи его элементов на ленты 3 и 4**:

1. Из файла 1 считывается первая компонента и помещается на ленту 3

2. Если следующая компонента файла 1 не меньше предыдущей, то она тоже направляется на ленту 3

3. В противном случае ее следует записать на ленту 4, куда теперь будут помещаться все компоненты до встречи новой инверсии — двух подряд идущих элементов, не соответствующих устанавливаемому порядку возрастания

4. После инверсии необходимо снова начать запись отрезка на ленту 3, после еще одной инверсии — снова на 4 и т. д. вплоть до исчерпания исходного файла 1

### Вторая часть: Слияние

После такого разделения начинается **операция слияния**:

1. Слияние осуществляется на ленту 1, поскольку она поступила в качестве исходных данных, она же должна содержать результат и её содержимое больше не нужно

2. Выполним слияние как обычно, запоминая при этом значение последней записанной на ленту 1 компоненты

3. Если эта последняя компонента больше, чем значения на лентах 3 и 4, то результат слияния необходимо направить на ленту 2

4. Как только ситуация повторится, следует вновь начать запись на ленту 1 и т. д. вплоть до исчерпания файлов 3 и 4

### Проверка завершения

Если в результате вышеописанной операции все данные окажутся в файле 1, а файл 2 окажется пуст, то **сортировка завершена**. 

Иначе следует повторить слияние с лент 1 и 2 с разделением на ленты 3 и 4, после чего проверить факт упорядоченности файла 3:
- В случае упорядоченности файл 3 следует переписать в файл 1 и закончить работу алгоритма
- В противном случае необходимо повторить слияние с лент 3 и 4 на 1 и 2

## Отзывчивость к частичной упорядоченности

**Отзывчивость естественного слияния на наличие упорядоченных отрезков в сортируемой последовательности — не единственное ее достоинство.**

### Сравнение с обычным слиянием

**Обычное слияние** в случае *любого* (упорядоченного, почти упорядоченного или совершенно неупорядоченного) файла выполняет строго `n · ⌈log₂ n⌉` действий.

**Сортировка естественным слиянием** работает так же плохо только в худшем случае обратно упорядоченного файла.

### Преимущество на упорядоченных данных

В случае упорядоченного файла естественному слиянию **необходимо пройти по файлу только один раз**, в то время как обычному опять необходимо `n · ⌈log₂ n⌉` операций.

**То есть** обычное слияние даже в случае почти упорядоченных последовательностей трудоголически выполняет отмеренное число операций, **совершенно не используя уже имеющийся частичный порядок**.

## Сложностная оценка

**Лучший случай (упорядоченный файл):** `O(n)` — один проход по файлу

**Худший случай (обратно упорядоченный файл):** `O(n log n)` — как у обычного слияния

**Средний случай:** `O(n log n)`, но с меньшими константами благодаря использованию частичной упорядоченности

**Пространственная сложность:** Требуется 4 ленты (или буфера)

## Преимущества

- **Естественность**: Адаптируется к частичной упорядоченности данных
- **Эффективность на почти упорядоченных данных**: `O(n)` в лучшем случае
- **Устойчивость**: Сохраняет относительный порядок равных элементов
- **Предсказуемость**: Не хуже обычного слияния в худшем случае
- **Использование реального порядка**: В отличие от обычного слияния, использует уже имеющуюся упорядоченность

## Недостатки

- **Сложность реализации**: Требует отслеживания инверсий и управления четырьмя лентами
- **Требует дополнительной памяти**: 4 ленты/буфера вместо 2
- **Худший случай**: На обратно упорядоченных данных работает не лучше обычного слияния
- **Накладные расходы**: Проверка инверсий добавляет операции

## Применимость

### Внешняя сортировка

Естественное слияние особенно эффективно для **внешней сортировки** файлов на магнитных лентах, дисках и других устройствах с последовательным доступом, где:
- Данные могут быть частично упорядочены
- Важна минимизация проходов по данным
- Доступно несколько лент/буферов

### Когда использовать

Естественное слияние оптимально для случаев, когда:
1. Ожидается частичная упорядоченность входных данных
2. Доступны 4 ленты/буфера
3. Важна производительность на почти упорядоченных данных
4. Нужна устойчивая сортировка

### Когда НЕ использовать

Не стоит использовать естественное слияние, если:
1. Данные гарантированно случайны или обратно упорядочены
2. Доступно мало памяти для буферов
3. Сложность реализации перевешивает преимущества

## Связь с другими алгоритмами

- **Обычное слияние (Merge Sort)**: Естественное слияние является оптимизацией, учитывающей частичную упорядоченность
- **Timsort**: Современный гибридный алгоритм, использующий похожую идею обнаружения упорядоченных участков (runs)

## Технические детали

### Обнаружение инверсий

**Инверсия** — два подряд идущих элемента, не соответствующих устанавливаемому порядку возрастания. При обнаружении инверсии происходит переключение на другую выходную ленту.

### Управление лентами

- **Лента 1**: Исходные данные, затем используется для результатов слияния
- **Лента 2**: Вспомогательная лента для результатов слияния
- **Ленты 3 и 4**: Используются для хранения разделенных упорядоченных отрезков

## Пример работы

```
Исходная последовательность на ленте 1:
[12, 45, 67] | [23, 89] | [5, 34, 56] | [90]

Разделение на ленты 3 и 4:
Лента 3: [12, 45, 67], [5, 34, 56]
Лента 4: [23, 89], [90]

После слияния:
[5, 12, 23, 34, 45, 56, 67, 89, 90]
```

## Заключение

Сортировка естественным слиянием — это **интеллектуальная оптимизация** обычного слияния, которая эффективно использует уже имеющуюся упорядоченность в данных. 

В отличие от "глупого" обычного слияния, которое делает фиксированное число операций независимо от входных данных, естественное слияние **адаптируется** к структуре данных, что делает его значительно быстрее на реальных данных, которые часто содержат частично упорядоченные участки.

Это классический пример того, как алгоритм может быть улучшен за счет учета реальных характеристик входных данных, а не предположения о наихудшем случае.

